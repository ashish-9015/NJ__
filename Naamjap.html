<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Naam Jap — Sacred Counter</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Devanagari:wght@300;400;600&family=Cinzel:wght@400;600&family=EB+Garamond:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0d0a06;
      --surface: #161109;
      --gold: #d4a843;
      --gold-light: #f0c96a;
      --gold-dim: #8a6820;
      --orange: #c4621a;
      --cream: #f5ead6;
      --text-dim: #a8956e;
      --glow: rgba(212, 168, 67, 0.25);
      --active-mantra: #d4a843;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      width: 100%; height: 100%;
      background: var(--bg);
      color: var(--cream);
      font-family: 'EB Garamond', Georgia, serif;
      overflow: hidden;
    }

    /* ── Mandala background ── */
    .bg-mandala {
      position: fixed; inset: 0;
      display: flex; align-items: center; justify-content: center;
      pointer-events: none; z-index: 0;
      opacity: 0.07;
    }
    .bg-mandala svg { width: min(90vw, 90vh); height: min(90vw, 90vh); }
    .mandala-ring { transform-origin: center; }
    .ring1 { animation: spin 120s linear infinite; }
    .ring2 { animation: spin 80s linear infinite reverse; }
    .ring3 { animation: spin 60s linear infinite; }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Layout ── */
    .app {
      position: relative; z-index: 1;
      display: grid;
      grid-template-rows: auto auto 1fr auto;
      height: 100vh; height: 100dvh;
      padding: 0;
    }

    /* ── Header ── */
    header {
      text-align: center;
      padding: 24px 20px 12px;
      border-bottom: 1px solid rgba(212,168,67,0.15);
    }
    header h1 {
      font-family: 'Cinzel', serif;
      font-size: clamp(1.4rem, 4vw, 2.2rem);
      letter-spacing: 0.25em;
      color: var(--gold-light);
      text-shadow: 0 0 40px var(--glow);
    }
    header p {
      font-size: 0.85rem;
      color: var(--text-dim);
      letter-spacing: 0.12em;
      margin-top: 4px;
      font-style: italic;
    }

    /* ── Main area ── */
    main {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 32px;
      padding: 20px;
      overflow: hidden;
    }

    /* ── Mantra selector ── */
    .mantra-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: center;
      max-width: 680px;
    }
    .mantra-tab {
      background: rgba(212,168,67,0.06);
      border: 1px solid rgba(212,168,67,0.2);
      color: var(--text-dim);
      font-family: 'EB Garamond', serif;
      font-size: 0.78rem;
      letter-spacing: 0.08em;
      padding: 5px 13px;
      border-radius: 2px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .mantra-tab:hover {
      border-color: var(--gold-dim);
      color: var(--gold);
    }
    .mantra-tab.active {
      background: rgba(212,168,67,0.14);
      border-color: var(--gold);
      color: var(--gold-light);
      box-shadow: 0 0 16px rgba(212,168,67,0.15);
    }

    /* ── Mantra display ── */
    .mantra-display {
      text-align: center;
      animation: fadeIn 0.5s ease;
    }
    .mantra-script {
      font-family: 'Noto Serif Devanagari', 'EB Garamond', serif;
      font-size: clamp(2rem, 7vw, 4rem);
      color: var(--gold-light);
      text-shadow: 0 0 60px rgba(212,168,67,0.5), 0 0 120px rgba(212,168,67,0.2);
      line-height: 1.3;
      letter-spacing: 0.05em;
      animation: pulse-glow 3s ease-in-out infinite;
    }
    .mantra-meaning {
      font-size: 0.85rem;
      color: var(--text-dim);
      font-style: italic;
      margin-top: 8px;
      letter-spacing: 0.08em;
    }

    @keyframes pulse-glow {
      0%, 100% { text-shadow: 0 0 60px rgba(212,168,67,0.4), 0 0 120px rgba(212,168,67,0.15); }
      50% { text-shadow: 0 0 80px rgba(212,168,67,0.7), 0 0 160px rgba(212,168,67,0.3); }
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    /* ── Counter button ── */
    .counter-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }

    .jap-btn {
      position: relative;
      width: clamp(160px, 35vw, 220px);
      height: clamp(160px, 35vw, 220px);
      border-radius: 50%;
      background: radial-gradient(ellipse at 35% 35%, #2a1f0a, #100c04);
      border: none;
      cursor: pointer;
      transition: transform 0.1s ease;
      outline: none;
      -webkit-tap-highlight-color: transparent;
    }

    /* Outer decorative rings */
    .jap-btn::before, .jap-btn::after {
      content: '';
      position: absolute;
      border-radius: 50%;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      transition: all 0.3s ease;
    }
    .jap-btn::before {
      width: calc(100% + 16px);
      height: calc(100% + 16px);
      border: 1px solid rgba(212,168,67,0.35);
      box-shadow: 0 0 20px rgba(212,168,67,0.1), inset 0 0 20px rgba(212,168,67,0.05);
    }
    .jap-btn::after {
      width: calc(100% + 32px);
      height: calc(100% + 32px);
      border: 1px dashed rgba(212,168,67,0.12);
    }

    .jap-btn-inner {
      position: absolute; inset: 0;
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border: 1px solid rgba(212,168,67,0.4);
      box-shadow:
        0 0 30px rgba(212,168,67,0.15),
        inset 0 0 30px rgba(212,168,67,0.08),
        inset 0 -2px 8px rgba(0,0,0,0.5);
      transition: all 0.12s ease;
    }

    .count-number {
      font-family: 'Cinzel', serif;
      font-size: clamp(2.8rem, 8vw, 4.5rem);
      color: var(--gold-light);
      line-height: 1;
      text-shadow: 0 0 30px var(--glow);
      transition: transform 0.1s ease;
    }
    .count-label {
      font-size: 0.7rem;
      color: var(--gold-dim);
      letter-spacing: 0.2em;
      text-transform: uppercase;
      margin-top: 4px;
    }

    /* Press state */
    .jap-btn:active {
      transform: scale(0.95);
    }
    .jap-btn:active .jap-btn-inner {
      box-shadow:
        0 0 50px rgba(212,168,67,0.35),
        inset 0 0 50px rgba(212,168,67,0.18),
        inset 0 -2px 8px rgba(0,0,0,0.5);
      background: radial-gradient(ellipse at 35% 35%, rgba(212,168,67,0.12), transparent);
    }
    .jap-btn:active .count-number {
      transform: scale(1.08);
      text-shadow: 0 0 60px rgba(240,201,106,0.8);
    }

    /* Ripple effect */
    .ripple {
      position: absolute;
      border-radius: 50%;
      border: 2px solid rgba(212,168,67,0.6);
      width: 100%; height: 100%;
      top: 0; left: 0;
      animation: ripple-out 0.8s ease-out forwards;
      pointer-events: none;
    }
    @keyframes ripple-out {
      0% { transform: scale(1); opacity: 0.8; }
      100% { transform: scale(1.9); opacity: 0; }
    }

    /* Mala dots (108) */
    .mala-track {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }
    .mala-info {
      font-size: 0.75rem;
      color: var(--text-dim);
      letter-spacing: 0.12em;
    }
    .mala-dots {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      max-width: 400px;
      justify-content: center;
    }
    .dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: rgba(212,168,67,0.1);
      border: 1px solid rgba(212,168,67,0.2);
      transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
    }
    .dot.done {
      background: var(--gold);
      border-color: var(--gold-light);
      box-shadow: 0 0 6px rgba(212,168,67,0.6);
    }
    .dot.current {
      background: var(--gold-light);
      border-color: #fff8e0;
      box-shadow: 0 0 10px rgba(240,201,106,0.9), 0 0 20px rgba(212,168,67,0.5);
      animation: dot-blink 0.55s ease-out forwards;
    }
    @keyframes dot-blink {
      0%   { transform: scale(1.8); box-shadow: 0 0 14px rgba(240,201,106,1), 0 0 28px rgba(212,168,67,0.7); }
      60%  { transform: scale(1.3); box-shadow: 0 0 10px rgba(240,201,106,0.8); }
      100% { transform: scale(1);   box-shadow: 0 0 6px rgba(212,168,67,0.6); }
    }

    /* ── Controls ── */
    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .ctrl-btn {
      background: transparent;
      border: 1px solid rgba(212,168,67,0.2);
      color: var(--text-dim);
      font-family: 'EB Garamond', serif;
      font-size: 0.78rem;
      letter-spacing: 0.15em;
      padding: 7px 18px;
      border-radius: 2px;
      cursor: pointer;
      transition: all 0.25s;
    }
    .ctrl-btn:hover {
      border-color: var(--gold-dim);
      color: var(--gold);
      background: rgba(212,168,67,0.05);
    }

    /* ── Footer ── */
    footer {
      text-align: center;
      padding: 14px 20px;
      border-top: 1px solid rgba(212,168,67,0.1);
    }
    .total-malas {
      font-family: 'Cinzel', serif;
      font-size: 0.78rem;
      color: var(--gold-dim);
      letter-spacing: 0.2em;
    }
    .total-malas span {
      color: var(--gold);
    }

    /* ── Flash animation on 108 complete ── */
    @keyframes flash-screen {
      0%, 100% { background: transparent; }
      50% { background: rgba(212,168,67,0.12); }
    }
    .flash { animation: flash-screen 0.6s ease; }

    /* ── Custom goal progress bar ── */
    .goal-bar-wrap {
      width: clamp(200px, 50vw, 320px);
      text-align: center;
    }
    .goal-label {
      font-size: 0.73rem;
      color: var(--text-dim);
      letter-spacing: 0.1em;
      margin-bottom: 6px;
    }
    .goal-bar {
      height: 3px;
      background: rgba(212,168,67,0.1);
      border-radius: 2px;
      overflow: hidden;
    }
    .goal-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--gold-dim), var(--gold-light));
      border-radius: 2px;
      width: 0%;
      transition: width 0.3s ease;
      box-shadow: 0 0 8px rgba(212,168,67,0.4);
    }

    /* ── Timer / Session ── */
    .session-bar {
      width: 100%;
      display: flex;
      justify-content: center;
      padding: 10px 20px 6px;
      border-bottom: 1px solid rgba(212,168,67,0.1);
    }
    .session-panel {
      display: flex;
      align-items: center;
      gap: 16px;
      background: rgba(212,168,67,0.05);
      border: 1px solid rgba(212,168,67,0.15);
      border-radius: 4px;
      padding: 10px 22px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .timer-display {
      font-family: 'Cinzel', serif;
      font-size: clamp(1.4rem, 4vw, 2rem);
      color: var(--gold-light);
      letter-spacing: 0.08em;
      text-shadow: 0 0 20px rgba(212,168,67,0.3);
      min-width: 100px;
      text-align: center;
    }
    .timer-display.running {
      animation: timer-pulse 1s ease-in-out infinite;
    }
    @keyframes timer-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    .timer-sep {
      width: 1px;
      height: 28px;
      background: rgba(212,168,67,0.2);
    }
    .timer-controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .tmr-btn {
      background: transparent;
      border: 1px solid rgba(212,168,67,0.25);
      color: var(--text-dim);
      font-family: 'EB Garamond', serif;
      font-size: 1rem;
      width: 34px; height: 34px;
      border-radius: 50%;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }
    .tmr-btn:hover {
      border-color: var(--gold);
      color: var(--gold-light);
      box-shadow: 0 0 10px rgba(212,168,67,0.2);
    }
    .tmr-btn.active-play {
      background: rgba(212,168,67,0.15);
      border-color: var(--gold);
      color: var(--gold-light);
    }
    .session-stats {
      display: flex;
      gap: 14px;
      align-items: center;
    }
    .stat-chip {
      text-align: center;
    }
    .stat-val {
      font-family: 'Cinzel', serif;
      font-size: 0.85rem;
      color: var(--gold);
      display: block;
    }
    .stat-key {
      font-size: 0.63rem;
      color: var(--text-dim);
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    /* ── Session History drawer ── */
    .history-toggle {
      background: transparent;
      border: none;
      color: var(--text-dim);
      font-family: 'EB Garamond', serif;
      font-size: 0.75rem;
      letter-spacing: 0.12em;
      cursor: pointer;
      padding: 4px 8px;
      border-bottom: 1px solid rgba(212,168,67,0.15);
      transition: color 0.2s;
      display: block;
      width: 100%;
      text-align: center;
    }
    .history-toggle:hover { color: var(--gold); }
    .history-drawer {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease;
    }
    .history-drawer.open { max-height: 200px; overflow-y: auto; }
    .history-list {
      padding: 8px 20px 12px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.78rem;
      color: var(--text-dim);
      padding: 4px 8px;
      border-radius: 2px;
      background: rgba(212,168,67,0.04);
      border: 1px solid rgba(212,168,67,0.08);
    }
    .history-item .hi-mantra { color: var(--gold); font-style: italic; }
    .history-item .hi-time   { font-family: 'Cinzel', serif; font-size: 0.72rem; color: var(--cream); }
    .history-item .hi-count  { color: var(--text-dim); font-size: 0.7rem; }
    .history-empty {
      font-size: 0.78rem;
      color: var(--gold-dim);
      font-style: italic;
      text-align: center;
      padding: 8px;
    }

    /* ── Footer stats ── */
    .footer-stats {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 28px;
      padding: 10px 20px 14px;
    }
    .footer-stat {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }
    .footer-stat-val {
      font-family: 'Cinzel', serif;
      font-size: clamp(1.1rem, 3vw, 1.5rem);
      color: var(--gold-light);
      text-shadow: 0 0 16px rgba(212,168,67,0.35);
      letter-spacing: 0.06em;
      transition: transform 0.15s ease, text-shadow 0.15s ease;
    }
    .footer-stat-val.bump {
      transform: scale(1.18);
      text-shadow: 0 0 28px rgba(240,201,106,0.7);
    }
    .footer-stat-key {
      font-size: 0.65rem;
      color: var(--text-dim);
      letter-spacing: 0.16em;
      text-transform: uppercase;
    }
    .footer-divider {
      width: 1px;
      height: 32px;
      background: rgba(212,168,67,0.2);
    }

    /* Responsive tweaks */
    @media (max-height: 700px) {
      .mala-dots { display: none; }
      main { gap: 14px; }
      .session-panel { padding: 7px 14px; gap: 10px; }
    }
    @media (max-width: 400px) {
      .mantra-tabs { gap: 5px; }
      .mantra-tab { font-size: 0.75rem; padding: 5px 10px; }
      .session-panel { gap: 10px; }
      .timer-sep { display: none; }
    }
  </style>
</head>
<body>

<!-- Mandala Background -->
<div class="bg-mandala">
  <svg viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg">
    <g class="mandala-ring ring1" transform="translate(200,200)">
      <circle r="180" fill="none" stroke="#d4a843" stroke-width="0.5"/>
      <circle r="160" fill="none" stroke="#d4a843" stroke-width="0.3" stroke-dasharray="6 4"/>
      <g id="p1">
        <ellipse rx="12" ry="40" cx="0" cy="-145" fill="none" stroke="#d4a843" stroke-width="0.8"/>
      </g>
      <use href="#p1" transform="rotate(30)"/>
      <use href="#p1" transform="rotate(60)"/>
      <use href="#p1" transform="rotate(90)"/>
      <use href="#p1" transform="rotate(120)"/>
      <use href="#p1" transform="rotate(150)"/>
      <use href="#p1" transform="rotate(180)"/>
      <use href="#p1" transform="rotate(210)"/>
      <use href="#p1" transform="rotate(240)"/>
      <use href="#p1" transform="rotate(270)"/>
      <use href="#p1" transform="rotate(300)"/>
      <use href="#p1" transform="rotate(330)"/>
    </g>
    <g class="mandala-ring ring2" transform="translate(200,200)">
      <circle r="120" fill="none" stroke="#d4a843" stroke-width="0.5"/>
      <g id="p2">
        <ellipse rx="8" ry="28" cx="0" cy="-96" fill="none" stroke="#d4a843" stroke-width="0.8"/>
        <circle r="4" cx="0" cy="-120" fill="none" stroke="#d4a843" stroke-width="0.6"/>
      </g>
      <use href="#p2" transform="rotate(45)"/>
      <use href="#p2" transform="rotate(90)"/>
      <use href="#p2" transform="rotate(135)"/>
      <use href="#p2" transform="rotate(180)"/>
      <use href="#p2" transform="rotate(225)"/>
      <use href="#p2" transform="rotate(270)"/>
      <use href="#p2" transform="rotate(315)"/>
    </g>
    <g class="mandala-ring ring3" transform="translate(200,200)">
      <circle r="60" fill="none" stroke="#d4a843" stroke-width="0.5"/>
      <circle r="30" fill="none" stroke="#d4a843" stroke-width="0.8"/>
      <g id="p3">
        <line x1="0" y1="-32" x2="0" y2="-58" stroke="#d4a843" stroke-width="0.6"/>
        <circle r="3" cx="0" cy="-65" fill="none" stroke="#d4a843" stroke-width="0.6"/>
      </g>
      <use href="#p3" transform="rotate(60)"/>
      <use href="#p3" transform="rotate(120)"/>
      <use href="#p3" transform="rotate(180)"/>
      <use href="#p3" transform="rotate(240)"/>
      <use href="#p3" transform="rotate(300)"/>
    </g>
    <circle cx="200" cy="200" r="8" fill="none" stroke="#d4a843" stroke-width="1"/>
    <circle cx="200" cy="200" r="3" fill="#d4a843"/>
  </svg>
</div>

<div class="app" id="app">
  <header>
    <h1>✦ NAAM JAP ✦</h1>
    <p>Sacred Mantra Counter</p>
  </header>

  <!-- Session Timer Bar -->
  <div class="session-bar">
    <div class="session-panel">
      <div class="timer-display" id="timerDisplay">00:00</div>
      <div class="timer-sep"></div>
      <div class="timer-controls">
        <button class="tmr-btn" id="btnPlayPause" title="Start / Pause">▶</button>
        <button class="tmr-btn" id="btnStop" title="End session">■</button>
      </div>
      <div class="timer-sep"></div>
      <div class="session-stats">
        <div class="stat-chip">
          <span class="stat-val" id="sessionJap">0</span>
          <span class="stat-key">This session</span>
        </div>
        <div class="stat-chip">
          <span class="stat-val" id="japsPerMin">—</span>
          <span class="stat-key">Jap / min</span>
        </div>
      </div>
    </div>
  </div>

  <main>
    <!-- Mantra selector -->
    <div class="mantra-tabs" id="mantraTabs"></div>

    <!-- Mantra text -->
    <div class="mantra-display">
      <div class="mantra-script" id="mantraScript"></div>
      <div class="mantra-meaning" id="mantraMeaning"></div>
    </div>

    <!-- Big tap button -->
    <div class="counter-wrap">
      <button class="jap-btn" id="japBtn" aria-label="Tap to count">
        <div class="jap-btn-inner">
          <div class="count-number" id="countNum">0</div>
          <div class="count-label">Jap</div>
        </div>
      </button>

      <!-- Controls -->
      <div class="controls">
        <button class="ctrl-btn" id="resetBtn">↺ Reset</button>
        <button class="ctrl-btn" id="resetAllBtn">✕ Reset All</button>
      </div>
    </div>

    <!-- Mala bead track (108 beads) -->
    <div class="mala-track">
      <div class="goal-bar-wrap">
        <div class="goal-label" id="malaProgressLabel">0 / 108 — Mala Progress</div>
        <div class="goal-bar"><div class="goal-fill" id="goalFill"></div></div>
      </div>
      <div class="mala-dots" id="malaDots"></div>
    </div>
  </main>

  <footer>
    <button class="history-toggle" id="historyToggle">▾ Session History</button>
    <div class="history-drawer" id="historyDrawer">
      <div class="history-list" id="historyList">
        <div class="history-empty">No sessions yet. Start a timer to begin.</div>
      </div>
    </div>
    <div class="footer-stats">
      <div class="footer-stat">
        <span class="footer-stat-val" id="totalJapCount">0</span>
        <span class="footer-stat-key">Total Naam Jap</span>
      </div>
      <div class="footer-divider"></div>
      <div class="footer-stat">
        <span class="footer-stat-val" id="malaCount">0</span>
        <span class="footer-stat-key">Malas Completed</span>
      </div>
    </div>
  </footer>
</div>

<script>
  const MANTRAS = [
    { id: 'waheguru',      tab: 'Waheguru',        script: 'ਵਾਹੇਗੁਰੂ',                    meaning: 'Wondrous Lord — the ecstasy of enlightenment' },
    { id: 'om',            tab: 'OM',              script: 'ॐ',                            meaning: 'The primordial sound of the universe' },
    { id: 'ram',           tab: 'Ram',             script: 'राम राम',                       meaning: 'The name of Lord Rama — source of all light' },
    { id: 'hare-krishna',  tab: 'Hare Krishna',    script: 'हरे कृष्ण हरे कृष्ण',           meaning: 'Calling upon the divine energy of Krishna' },
    { id: 'gayatri',       tab: 'Gāyatrī',        script: 'ॐ भूर् भुवः स्वः',              meaning: 'The supreme mantra of illumination' },
    { id: 'so-hum',        tab: 'So Hum',         script: 'सो हम्',                        meaning: 'I am That — the breath of the cosmos' },
    { id: 'sat-nam',       tab: 'Sat Nām',        script: 'ਸਤਿ ਨਾਮੁ',                     meaning: 'True is the Name — reality as divine' },
    { id: 'kali',          tab: 'Jai Kali',        script: 'जय काली माँ',                   meaning: 'Victory to Mother Kali — destroyer of darkness' },
    { id: 'radha',         tab: 'Radha',           script: 'राधे राधे',                     meaning: 'Radha — the divine beloved, embodiment of devotion' },
    { id: 'om-namah-shivay', tab: 'Om Namah Shivay', script: 'ॐ नमः शिवाय',               meaning: 'I bow to Lord Shiva — the auspicious one' },
    { id: 'krishna',       tab: 'Krishna',         script: 'ॐ नमो भगवते वासुदेवाय',        meaning: 'I bow to Lord Krishna, the son of Vasudeva' },
    { id: 'hanuman',       tab: 'Jai Hanuman',     script: 'जय हनुमान',                    meaning: 'Victory to Hanuman — symbol of strength & devotion' },
  ];

  const MALA = 108;

  // ── Persistent state ──
  let state    = JSON.parse(localStorage.getItem('naamjap_state')   || '{}');
  let sessions = JSON.parse(localStorage.getItem('naamjap_sessions')|| '[]');
  let activeId = localStorage.getItem('naamjap_active') || MANTRAS[0].id;

  // ── Timer state ──
  let timerInterval  = null;
  let timerSeconds   = 0;
  let timerRunning   = false;
  let sessionStart   = null;   // count at session start
  let sessionCountEl = 0;

  // ── DOM refs ──
  const tabsEl         = document.getElementById('mantraTabs');
  const scriptEl       = document.getElementById('mantraScript');
  const meaningEl      = document.getElementById('mantraMeaning');
  const countEl        = document.getElementById('countNum');
  const japBtn         = document.getElementById('japBtn');
  const resetBtn       = document.getElementById('resetBtn');
  const resetAllBtn    = document.getElementById('resetAllBtn');
  const malaDots       = document.getElementById('malaDots');
  const malaCount      = document.getElementById('malaCount');
  const totalJapCount  = document.getElementById('totalJapCount');
  const goalFill       = document.getElementById('goalFill');
  const malaLabel      = document.getElementById('malaProgressLabel');
  const timerDisplay   = document.getElementById('timerDisplay');
  const btnPlayPause   = document.getElementById('btnPlayPause');
  const btnStop        = document.getElementById('btnStop');
  const sessionJapEl   = document.getElementById('sessionJap');
  const japsPerMinEl   = document.getElementById('japsPerMin');
  const historyToggle  = document.getElementById('historyToggle');
  const historyDrawer  = document.getElementById('historyDrawer');
  const historyList    = document.getElementById('historyList');

  // ── Build mantra tabs ──
  MANTRAS.forEach(m => {
    const btn = document.createElement('button');
    btn.className = 'mantra-tab' + (m.id === activeId ? ' active' : '');
    btn.textContent = m.tab;
    btn.dataset.id = m.id;
    btn.addEventListener('click', () => selectMantra(m.id));
    tabsEl.appendChild(btn);
  });

  // ── Build mala dots ──
  for (let i = 0; i < MALA; i++) {
    const d = document.createElement('div');
    d.className = 'dot'; d.dataset.i = i;
    malaDots.appendChild(d);
  }

  // ── Timer helpers ──
  function fmtTime(s) {
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const sec = s % 60;
    if (h > 0) return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
    return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
  }

  function tickTimer() {
    timerSeconds++;
    timerDisplay.textContent = fmtTime(timerSeconds);
    renderSessionStats();
  }

  function startTimer() {
    if (timerRunning) return;
    if (sessionStart === null) sessionStart = getCount(activeId); // capture start count
    timerRunning = true;
    timerInterval = setInterval(tickTimer, 1000);
    timerDisplay.classList.add('running');
    btnPlayPause.textContent = '⏸';
    btnPlayPause.classList.add('active-play');
  }

  function pauseTimer() {
    timerRunning = false;
    clearInterval(timerInterval);
    timerInterval = null;
    timerDisplay.classList.remove('running');
    btnPlayPause.textContent = '▶';
    btnPlayPause.classList.remove('active-play');
  }

  function stopTimer() {
    if (timerSeconds === 0 && sessionStart === null) return;
    // Save session
    const sessionJaps = getCount(activeId) - (sessionStart || 0);
    const m = MANTRAS.find(x => x.id === activeId);
    sessions.unshift({
      mantra: m.tab,
      mantraScript: m.script,
      duration: timerSeconds,
      japs: Math.max(0, sessionJaps),
      date: new Date().toLocaleDateString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })
    });
    if (sessions.length > 20) sessions = sessions.slice(0, 20);
    localStorage.setItem('naamjap_sessions', JSON.stringify(sessions));

    // Reset timer
    pauseTimer();
    timerSeconds = 0;
    sessionStart = null;
    timerDisplay.textContent = '00:00';
    timerDisplay.classList.remove('running');
    sessionJapEl.textContent = '0';
    japsPerMinEl.textContent = '—';

    renderHistory();
  }

  function renderSessionStats() {
    const elapsed = timerSeconds;
    const japs = getCount(activeId) - (sessionStart || 0);
    sessionJapEl.textContent = Math.max(0, japs);
    if (elapsed >= 10 && japs > 0) {
      const rate = ((japs / elapsed) * 60).toFixed(1);
      japsPerMinEl.textContent = rate;
    } else {
      japsPerMinEl.textContent = '—';
    }
  }

  btnPlayPause.addEventListener('click', () => {
    timerRunning ? pauseTimer() : startTimer();
  });
  btnStop.addEventListener('click', stopTimer);

  // ── History ──
  function renderHistory() {
    historyList.innerHTML = '';
    if (!sessions.length) {
      historyList.innerHTML = '<div class="history-empty">No sessions yet. Start a timer to begin.</div>';
      return;
    }
    sessions.forEach(s => {
      const el = document.createElement('div');
      el.className = 'history-item';
      el.innerHTML = `
        <span class="hi-mantra">${s.mantra} <small>${s.mantraScript}</small></span>
        <span class="hi-time">${fmtTime(s.duration)}</span>
        <span class="hi-count">${s.japs} jap · ${s.date}</span>
      `;
      historyList.appendChild(el);
    });
  }

  historyToggle.addEventListener('click', () => {
    historyDrawer.classList.toggle('open');
    historyToggle.textContent = historyDrawer.classList.contains('open')
      ? '▴ Session History' : '▾ Session History';
  });

  // ── Core functions ──
  function getCount(id) { return state[id] || 0; }

  function selectMantra(id) {
    activeId = id;
    localStorage.setItem('naamjap_active', id);
    document.querySelectorAll('.mantra-tab').forEach(b =>
      b.classList.toggle('active', b.dataset.id === id));
    const m = MANTRAS.find(x => x.id === id);
    scriptEl.style.animation = 'none';
    requestAnimationFrame(() => {
      scriptEl.style.animation = '';
      scriptEl.textContent = m.script;
    });
    meaningEl.textContent = m.meaning;
    render();
  }

  function saveState() {
    localStorage.setItem('naamjap_state', JSON.stringify(state));
  }

  function render() {
    const c = getCount(activeId);
    countEl.textContent = c;
    const inMala = c % MALA;
    const malas  = Math.floor(c / MALA);
    const pct = (inMala / MALA) * 100;
    goalFill.style.width = pct + '%';
    malaLabel.textContent = `${inMala} / 108 — Mala Progress`;
    malaCount.textContent = malas;

    // Total Naam Jap across ALL mantras
    const total = Object.values(state).reduce((sum, v) => sum + v, 0);
    totalJapCount.textContent = total.toLocaleString();

    document.querySelectorAll('.dot').forEach(d => {
      const i = parseInt(d.dataset.i);
      d.classList.toggle('done', i < inMala);
      d.classList.toggle('current', i === inMala && inMala < MALA);
    });
    if (timerRunning || sessionStart !== null) renderSessionStats();
  }

  function bumpStat(el) {
    el.classList.remove('bump');
    void el.offsetWidth; // reflow
    el.classList.add('bump');
    setTimeout(() => el.classList.remove('bump'), 200);
  }

  function tap() {
    if (!state[activeId]) state[activeId] = 0;
    state[activeId]++;
    saveState();

    // Auto-start timer on first tap if not running
    if (!timerRunning && sessionStart === null) startTimer();

    // Ripple
    const ripple = document.createElement('div');
    ripple.className = 'ripple';
    japBtn.appendChild(ripple);
    setTimeout(() => ripple.remove(), 800);

    // Mala completion flash
    if (state[activeId] % MALA === 0) {
      document.getElementById('app').classList.add('flash');
      setTimeout(() => document.getElementById('app').classList.remove('flash'), 600);
    }
    render();
    // Re-trigger blink on current dot
    const currentDot = document.querySelector('.dot.current');
    if (currentDot) {
      currentDot.classList.remove('current');
      void currentDot.offsetWidth;
      currentDot.classList.add('current');
    }
    bumpStat(totalJapCount);
    if (state[activeId] % MALA === 0) bumpStat(malaCount);
  }
  document.addEventListener('keydown', e => {
    if (e.code === 'Space' || e.code === 'Enter') { e.preventDefault(); tap(); }
  });

  resetBtn.addEventListener('click', () => {
    if (confirm('Reset count for this mantra?')) {
      state[activeId] = 0;
      saveState(); render();
    }
  });

  resetAllBtn.addEventListener('click', () => {
    if (confirm('Reset ALL mantra counts?')) {
      state = {};
      saveState(); render();
    }
  });

  // ── Init ──
  selectMantra(activeId);
  renderHistory();
</script>
</body>
</html>
